Adapted from https://github.com/wong2/batchexecute/tree/main